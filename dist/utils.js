"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.StringBuilder = exports.updateSource = exports.isMethodNamed = exports.className = exports.isEntry = exports.isUserEntry = exports.cloneNode = exports.getName = exports.toString = exports.not = exports.isLibrary = exports.getDecorator = exports.hasDecorator = exports.isDecorator = exports.decorates = void 0;
const as_1 = require("../as");
const astBuilder_1 = require("./astBuilder");
const cloneDeep = require("lodash.clonedeep");
function decorates(node, name) {
    return node.name.text === name;
}
exports.decorates = decorates;
function isDecorator(name) {
    return (node) => decorates(node, name);
}
exports.isDecorator = isDecorator;
function hasDecorator(node, name) {
    var _a;
    let decl;
    if (node instanceof as_1.DeclarationStatement) {
        decl = node;
    }
    else {
        decl = node.declaration;
    }
    // because it could be undefined
    return ((_a = decl.decorators) === null || _a === void 0 ? void 0 : _a.some(isDecorator(name))) == true;
}
exports.hasDecorator = hasDecorator;
function getDecorator(node, name) {
    var _a;
    return (_a = node.decorators) === null || _a === void 0 ? void 0 : _a.find(isDecorator(name));
}
exports.getDecorator = getDecorator;
function isLibrary(node) {
    return node.isLibrary || node.internalPath.startsWith("~lib/rt/");
}
exports.isLibrary = isLibrary;
function not(fn) {
    return (t) => !fn(t);
}
exports.not = not;
function toString(node) {
    return astBuilder_1.ASTBuilder.build(node);
}
exports.toString = toString;
function getName(node) {
    if (node instanceof as_1.TypeNode) {
        return node.range.toString();
    }
    if (node instanceof as_1.ClassDeclaration || node instanceof as_1.InterfaceDeclaration) {
        return className(node);
    }
    return node.name.range.toString();
}
exports.getName = getName;
function cloneNode(node) {
    return cloneDeep(node);
}
exports.cloneNode = cloneNode;
function isUserEntry(node) {
    return node.range.source.sourceKind == as_1.SourceKind.USER_ENTRY;
}
exports.isUserEntry = isUserEntry;
function isEntry(node) {
    return isUserEntry(node) || node.range.source.sourceKind == as_1.SourceKind.LIBRARY_ENTRY;
}
exports.isEntry = isEntry;
function className(_class) {
    let name = _class.name.range.toString();
    const typeParameters = _class.typeParameters;
    if (typeParameters) {
        name += `<${typeParameters.map(getName).join(", ")}>`;
    }
    return name;
}
exports.className = className;
function isMethodNamed(name) {
    return (stmt) => stmt.kind == as_1.NodeKind.METHODDECLARATION && toString(stmt.name) === name;
}
exports.isMethodNamed = isMethodNamed;
function updateSource(program, newSource) {
    const sources = program.sources;
    for (let i = 0, len = sources.length; i < len; i++) {
        if (sources[i].internalPath == newSource.internalPath) {
            sources[i] = newSource;
            break;
        }
    }
}
exports.updateSource = updateSource;
class StringBuilder {
    constructor() {
        this.sb = [];
    }
    push(s) {
        this.sb.push(s);
    }
    finish(separator = "\n") {
        let res = this.sb.join(separator);
        this.sb = [];
        return res;
    }
    get last() { return this.sb[this.sb.length - 1]; }
}
exports.StringBuilder = StringBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBWWU7QUFDZiw2Q0FBMEM7QUFFMUMsTUFBTSxTQUFTLEdBQW1CLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBRTlELFNBQWdCLFNBQVMsQ0FBQyxJQUFtQixFQUFFLElBQVk7SUFDekQsT0FBOEIsSUFBSSxDQUFDLElBQUssQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDO0FBQ3pELENBQUM7QUFGRCw4QkFFQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxJQUFZO0lBQ3RDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDekMsQ0FBQztBQUZELGtDQUVDO0FBR0QsU0FBZ0IsWUFBWSxDQUMxQixJQUFnRSxFQUNoRSxJQUFZOztJQUVaLElBQUksSUFBSSxDQUFDO0lBQ1QsSUFBSSxJQUFJLFlBQVkseUJBQW9CLEVBQUU7UUFDeEMsSUFBSSxHQUFHLElBQUksQ0FBQztLQUNiO1NBQU07UUFDTCxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztLQUN6QjtJQUNELGdDQUFnQztJQUNoQyxPQUFPLE9BQUEsSUFBSSxDQUFDLFVBQVUsMENBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBSyxJQUFJLENBQUM7QUFDMUQsQ0FBQztBQVpELG9DQVlDO0FBRUQsU0FBZ0IsWUFBWSxDQUMxQixJQUEwQixFQUMxQixJQUFZOztJQUVaLE9BQU8sTUFBQSxJQUFJLENBQUMsVUFBVSwwQ0FBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFFLENBQUM7QUFDbkQsQ0FBQztBQUxELG9DQUtDO0FBRUQsU0FBZ0IsU0FBUyxDQUFDLElBQVk7SUFDcEMsT0FBTyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxZQUFZ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Q0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUk7UUFDckIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRCxJQUFLLElBQUksS0FBYSxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEdBQUUsQ0FBQyxDQUFDLENBQUEsQ0FBQSxDQUFDO0NBQ3pEO0FBZEQsc0NBY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERlY29yYXRvck5vZGUsXHJcbiAgSWRlbnRpZmllckV4cHJlc3Npb24sXHJcbiAgRGVjbGFyYXRpb25TdGF0ZW1lbnQsXHJcbiAgU291cmNlLFxyXG4gIE5vZGUsXHJcbiAgU291cmNlS2luZCxcclxuICBQcm9ncmFtLFxyXG4gIENsYXNzRGVjbGFyYXRpb24sXHJcbiAgVHlwZU5vZGUsXHJcbiAgTm9kZUtpbmQsXHJcbiAgSW50ZXJmYWNlRGVjbGFyYXRpb24sXHJcbn0gZnJvbSBcIi4uL2FzXCI7XHJcbmltcG9ydCB7IEFTVEJ1aWxkZXIgfSBmcm9tIFwiLi9hc3RCdWlsZGVyXCI7XHJcblxyXG5jb25zdCBjbG9uZURlZXA6IDxUPih0OiBUKSA9PiBUID0gcmVxdWlyZShcImxvZGFzaC5jbG9uZWRlZXBcIik7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVjb3JhdGVzKG5vZGU6IERlY29yYXRvck5vZGUsIG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gIHJldHVybiAoPElkZW50aWZpZXJFeHByZXNzaW9uPm5vZGUubmFtZSkudGV4dCA9PT0gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRGVjb3JhdG9yKG5hbWU6IHN0cmluZyk6IChub2RlOiBEZWNvcmF0b3JOb2RlKSA9PiBib29sZWFuIHtcclxuICByZXR1cm4gKG5vZGUpID0+IGRlY29yYXRlcyhub2RlLCBuYW1lKTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBoYXNEZWNvcmF0b3IoXHJcbiAgbm9kZTogRGVjbGFyYXRpb25TdGF0ZW1lbnQgfCB7ZGVjbGFyYXRpb246IERlY2xhcmF0aW9uU3RhdGVtZW50fSxcclxuICBuYW1lOiBzdHJpbmdcclxuKTogYm9vbGVhbiB7XHJcbiAgbGV0IGRlY2w7XHJcbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBEZWNsYXJhdGlvblN0YXRlbWVudCkge1xyXG4gICAgZGVjbCA9IG5vZGU7XHJcbiAgfSBlbHNlIHtcclxuICAgIGRlY2wgPSBub2RlLmRlY2xhcmF0aW9uOyBcclxuICB9IFxyXG4gIC8vIGJlY2F1c2UgaXQgY291bGQgYmUgdW5kZWZpbmVkXHJcbiAgcmV0dXJuIGRlY2wuZGVjb3JhdG9ycz8uc29tZShpc0RlY29yYXRvcihuYW1lKSkgPT0gdHJ1ZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERlY29yYXRvcihcclxuICBub2RlOiBEZWNsYXJhdGlvblN0YXRlbWVudCxcclxuICBuYW1lOiBzdHJpbmdcclxuKTogRGVjb3JhdG9yTm9kZSB7XHJcbiAgcmV0dXJuIG5vZGUuZGVjb3JhdG9ycz8uZmluZChpc0RlY29yYXRvcihuYW1lKSkhO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNMaWJyYXJ5KG5vZGU6IFNvdXJjZSk6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBub2RlLmlzTGlicmFyeSB8fCBub2RlLmludGVybmFsUGF0aC5zdGFydHNXaXRoKFwifmxpYi9ydC9cIik7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBub3Q8VD4oZm46ICh0OiBUKSA9PiBib29sZWFuKTogKHQ6IFQpID0+IGJvb2xlYW4ge1xyXG4gIHJldHVybiAodDogVCkgPT4gIWZuKHQpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdG9TdHJpbmcobm9kZTogTm9kZSk6IHN0cmluZyB7XHJcbiAgcmV0dXJuIEFTVEJ1aWxkZXIuYnVpbGQobm9kZSk7XHJcbn1cclxuXHJcbmludGVyZmFjZSBOYW1lZCB7XHJcbiAgbmFtZTogSWRlbnRpZmllckV4cHJlc3Npb247XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmFtZShub2RlOiBOb2RlICYgTmFtZWQgfCBUeXBlTm9kZSk6IHN0cmluZyB7XHJcbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBUeXBlTm9kZSkge1xyXG4gICAgcmV0dXJuIG5vZGUucmFuZ2UudG9TdHJpbmcoKTtcclxuICB9XHJcbiAgaWYgKG5vZGUgaW5zdGFuY2VvZiBDbGFzc0RlY2xhcmF0aW9uIHx8IG5vZGUgaW5zdGFuY2VvZiBJbnRlcmZhY2VEZWNsYXJhdGlvbikge1xyXG4gICAgcmV0dXJuIGNsYXNzTmFtZShub2RlKTtcclxuICB9XHJcbiAgcmV0dXJuIG5vZGUubmFtZS5yYW5nZS50b1N0cmluZygpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVOb2RlPFQgZXh0ZW5kcyBOb2RlPihub2RlOiBUKTogVCB7XHJcbiAgcmV0dXJuIGNsb25lRGVlcChub2RlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVXNlckVudHJ5KG5vZGU6IE5vZGUpOiBib29sZWFuIHtcclxuICByZXR1cm4gbm9kZS5yYW5nZS5zb3VyY2Uuc291cmNlS2luZCA9PSBTb3VyY2VLaW5kLlVTRVJfRU5UUlk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0VudHJ5KG5vZGU6IE5vZGUpOiBib29sZWFuIHtcclxuICByZXR1cm4gaXNVc2VyRW50cnkobm9kZSkgfHwgbm9kZS5yYW5nZS5zb3VyY2Uuc291cmNlS2luZCA9PSBTb3VyY2VLaW5kLkxJQlJBUllfRU5UUlk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjbGFzc05hbWUoX2NsYXNzOiBDbGFzc0RlY2xhcmF0aW9uIHwgIEludGVyZmFjZURlY2xhcmF0aW9uKTogc3RyaW5nIHtcclxuICBsZXQgbmFtZSA9IF9jbGFzcy5uYW1lLnJhbmdlLnRvU3RyaW5nKCk7XHJcbiAgY29uc3QgdHlwZVBhcmFtZXRlcnMgPSBfY2xhc3MudHlwZVBhcmFtZXRlcnM7XHJcbiAgaWYgKHR5cGVQYXJhbWV0ZXJzKSB7XHJcbiAgICBuYW1lICs9IGA8JHt0eXBlUGFyYW1ldGVycy5tYXAoZ2V0TmFtZSkuam9pbihcIiwgXCIpfT5gO1xyXG4gIH1cclxuICByZXR1cm4gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWV0aG9kTmFtZWQobmFtZTogc3RyaW5nKTogKF86IERlY2xhcmF0aW9uU3RhdGVtZW50KSA9PiBib29sZWFuIHtcclxuICByZXR1cm4gKHN0bXQ6IERlY2xhcmF0aW9uU3RhdGVtZW50KSA9PiBzdG10LmtpbmQgPT0gTm9kZUtpbmQuTUVUSE9EREVDTEFSQVRJT04gJiYgdG9TdHJpbmcoc3RtdC5uYW1lKSA9PT0gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVNvdXJjZShwcm9ncmFtOiBQcm9ncmFtLCBuZXdTb3VyY2U6IFNvdXJjZSkge1xyXG4gIGNvbnN0IHNvdXJjZXMgPSBwcm9ncmFtLnNvdXJjZXM7XHJcbiAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHNvdXJjZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgaWYgKHNvdXJjZXNbaV0uaW50ZXJuYWxQYXRoID09IG5ld1NvdXJjZS5pbnRlcm5hbFBhdGgpIHtcclxuICAgICAgICAgIHNvdXJjZXNbaV0gPSBuZXdTb3VyY2U7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFN0cmluZ0J1aWxkZXIge1xyXG4gIHByaXZhdGUgc2I6IHN0cmluZ1tdID0gW107XHJcblxyXG4gIHB1c2goczogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnNiLnB1c2gocyk7XHJcbiAgfVxyXG5cclxuICBmaW5pc2goc2VwYXJhdG9yID0gXCJcXG5cIik6IHN0cmluZyB7XHJcbiAgICBsZXQgcmVzID0gdGhpcy5zYi5qb2luKHNlcGFyYXRvcik7XHJcbiAgICB0aGlzLnNiID0gW107XHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgZ2V0ICBsYXN0KCk6IHN0cmluZyB7IHJldHVybiB0aGlzLnNiW3RoaXMuc2IubGVuZ3RoIC0xXX1cclxufSJdfQ==